<!doctype html>
<html lang="en" class="no-js">
{% load static %}
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <title>Character Metrics</title>
    <meta name="description" content="Simplified Bootstrap template with sticky menu">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/sticky-menu.css' %}" rel="stylesheet">
    <style>
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
        }
        @media (max-width: 768px) {
            .navbar-header .navbar-toggle {
                float: left;
                margin-left: 15px;
            }
            .navbar-header {
                float: none;
            }
            .navbar-collapse {
                display: none !important;
            }
            .navbar-collapse.collapse {
                display: none !important;
            }
            .navbar-nav {
                float: none !important;
                margin: 7.5px -15px;
            }
            .navbar-nav>li {
                float: none;
            }
            .navbar-nav>li>a {
                padding-top: 10px;
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle menu</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">Welcome</a>
            </div>

            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    <li class="hidden">
                        <a class="page-scroll" href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#about">Character Metrics</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#whatwedo">Results</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section id="Welcome" class="welcome-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1>Public Character Metrics Collector</h1>
                    <br>
                    <br>
                    <a class="btn btn-primary page-scroll" href="#about">Character Metrics Section</a>
                </div>
            </div>
        </div>
    </section>

    <section id="about" class="about-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1>Input the creator's handle to see all of their character's metrics</h1>
                    <br>
                    <br>
                </div>
                <div class="col-lg-12">
                    <form id='CreatorHandleForm' method="post" onsubmit="fetchMetrics(event)" class="show-loading-after-submit">
                      {% csrf_token %}
                      {{ form.as_p }}
                      <br>
                      <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <div id="loading">
        <img src="{% static 'img/wait.gif' %}" alt="Loading...">
    </div>

    <section id="whatwedo" class="whatwedo-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                  <table class="table table-dark table-striped">
                    <thead>
                      <tr>
                        <th>Total Chats</th>
                        <th>Total Messages</th>
                        <th>Likes</th>
                        <th>Dislikes</th>
                        <th>Creator</th>
                        <th>Published Date</th>
                        <th>Last Updated</th>
                        <th>Avg Messages/Day</th>
                        <th>Avg Chats/Day</th>
                        <th>Avg Likes/Day</th>
                      </tr>
                    </thead>
                    <tbody id="metrics-container">
                      <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                  </table>
                </div>
            </div>
        </div>
    </section>

    <a id="back2Top" title="Back to top" href="#">&#10148;</a>

    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/jquery.easing.min.js' %}"></script>
    <script src="{% static 'js/sticky-menu.js' %}"></script>

    <script>
        async function fetchMetrics(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const csrfToken = formData.get('csrfmiddlewaretoken');
            document.getElementById('loading').style.display = 'block';

            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            });

            const result = await response.json();
            const taskId = result.task_id;
            checkTaskStatus(taskId);
        }

        async function checkTaskStatus(taskId) {
            const response = await fetch(`/get_task_result/${taskId}/`);
            const result = await response.json();
            if (result.status === 'pending') {
                setTimeout(() => checkTaskStatus(taskId), 1000);
            } else if (result.status === 'completed') {
                displayMetrics(result.data);
                document.getElementById('loading').style.display = 'none';
            } else {
                alert('An error occurred: ' + result.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayMetrics(metrics) {
            const metricsContainer = document.getElementById('metrics-container');
            metricsContainer.innerHTML = '';
            metrics.forEach(metric => {
                const row = `<tr>
                    <td>${metric.Total_Chats}</td>
                    <td>${metric.Total_Messages}</td>
                    <td>${metric.Likes}</td>
                    <td>${metric.Dislikes}</td>
                    <td>${metric.Creator}</td>
                    <td>${metric.Published_Date}</td>
                    <td>${metric.Last_Updated}</td>
                    <td>${metric.Avg_Messages_Day}</td>
                    <td>${metric.Avg_Chats_Day}</td>
                    <td>${metric.Avg_Likes_Day}</td>
                </tr>`;
                metricsContainer.innerHTML += row;
            });
        }
    </script>
</body>
</html>
