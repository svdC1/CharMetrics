<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Metrics</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- Optionally include Bootstrap for easier responsiveness -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicons/favicon-16x16.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicons/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" href="{% static 'images/favicons/favicon.ico' %}">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/favicons/apple-touch-icon.png' %}">

    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'images/favicons/android-chrome-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="512x512" href="{% static 'images/favicons/android-chrome-512x512.png' %}">

    <!-- Manifest file -->
    <link rel="manifest" href="{% static 'images/favicons/site.webmanifest' %}">
    <style>
       .loading {
           display: block;
           position: fixed;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
       }
       .loading img {
           width: 100%;
           max-width: 150px; /* Adjust the max-width as needed */
       }
        .error-message {
            display: none;
            color: red;
            font-weight: bold;
        }
   </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Creator Data</h1>
        <div id="loading" class="loading">
            <br>
            <h3>Processing...</h3>
            <br>
            <p>Estimated time: 1-5 minutes depending on number of character.</p>
            <br>
            <img src="{% static 'images/loading.gif' %}" alt="Loading...">
        </div>
        <div id="error-message" class="error-message">Something went wrong...Please Reload The Page.</div>
        <div id="results" style="display: none;">
            <p>Data retrieval time: <span id="retrieval_time"></span> seconds</p>

            <h1>Across All Characters</h1>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Total Messages</th>
                            <th>Total Chats</th>
                            <th>Likes</th>
                            <th>Dislikes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="sum_data">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h1>Character Data</h1>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Name</th>
                            <th>Total Messages</th>
                            <th>Total Chats</th>
                            <th>Likes</th>
                            <th>Dislikes</th>
                            <th>Date Published</th>
                            <th>Last Updated</th>
                            <th>Average Messages/Day</th>
                            <th>Average Chats/Day</th>
                        </tr>
                    </thead>
                    <tbody id="character_data"></tbody>
                </table>
            </div>
        </div>
    </div>
<script>
async function checkTaskStatus(taskId) {
    console.log(`Checking status for task ID: ${taskId}`);
    try {
        const response = await fetch(`/task_status/${taskId}/`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log('Task status response:', data);

        const loadingElement = document.getElementById('loading');
        const resultsElement = document.getElementById('results');
        const errorMessageElement = document.getElementById('error-message');

        if (!loadingElement) {
            console.error('Loading element not found');
            return;
        }
        if (!resultsElement) {
            console.error('Results element not found');
            return;
        }

        if (data.state === 'SUCCESS') {
            loadingElement.style.display = 'none';
            resultsElement.style.display = 'block';
            const retrievalTimeElement = document.getElementById('retrieval_time');
            const sumDataElement = document.getElementById('sum_data');
            const characterDataElement = document.getElementById('character_data');
            if (!retrievalTimeElement || !sumDataElement || !characterDataElement) {
                console.error('One or more result elements not found');
                return;

            }
        retrievalTimeElement.innerText = data.result.retrieval_time;
        const sumData = data.result.sum;
        sumDataElement.innerHTML = `
        <td>${sumData.total_messages}</td>
        <td>${sumData.total_chats}</td>
        <td>${sumData.likes}</td>
        <td>${sumData.dislikes}</td>
        `;

    characterDataElement.innerHTML = '';

    if (Array.isArray(data.result.characters)) {
        data.result.characters.forEach(character => {
            console.log('Processing character:', character);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${character.name}</td>
                <td>${character.total_messages}</td>
                <td>${character.total_chats}</td>
                <td>${character.likes}</td>
                <td>${character.dislikes}</td>
                <td>${character.date_published}</td>
                <td>${character.last_updated}</td>
                <td>${character.avg_messages_day}</td>
                <td>${character.avg_chats_day}</td>
            `;
            characterDataElement.appendChild(row);
        });
    } else {
        console.error('Expected data.result.characters to be an array:', data.result.characters);
    }}
    else if (data.state === 'FAILURE') {
        console.error('Task failed:', data.status);
        loadingElement.style.display = 'none';
        if (errorMessageElement) {
            errorMessageElement.innerText = data.status;
            errorMessageElement.style.display = 'block';

        }

    }
    else {
        console.log(`Task state: ${data.state}. Retrying in 2 seconds...`);
        setTimeout(() => checkTaskStatus(taskId), 2000);}}

    catch (error) {
        console.error('Error fetching task status:', error);
        const loadingElement = document.getElementById('loading');
        if (loadingElement) {
            loadingElement.style.display = 'none';}

        const errorMessageElement = document.getElementById('error-message');
        if (errorMessageElement) {
            errorMessageElement.style.display = 'block';}
        else {
            console.error('Error message element not found');
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('task_id');

    if (taskId) {
        const loadingElement = document.getElementById('loading');
        if (loadingElement) {
            loadingElement.style.display = 'block';
        }
        checkTaskStatus(taskId);
    } else {
        console.error('Task ID not found in URL');
    }
});

    </script>
</body>
</body>
</html>
